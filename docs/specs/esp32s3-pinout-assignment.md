# ESP32-S3 DevKitC-1 ピンアサイン確定版

**プロジェクト**: FU@ComoNe (Fragmentations of Unity @ Common Nexus)
**ボード**: ESP32-S3-DevKitC-1
**確定日**: 2025-10-17
**基板**: WPCBB (Winch PCB Board)

---

## 📋 ピンアウト図

参照図:
- [esp32s3-devkitc-pinout-reference.png](../../notes/esp32s3-devkitc-pinout-reference.png) - 参照ピンアウト図
- [esp32s3-devkitc-actual-board.png](../../notes/esp32s3-devkitc-actual-board.png) - 実際のボード写真（シルク確認用）

---

## 🔌 確定ピンアサイン（実際のボード配置）

### 左側ヘッダー（上から下）

| シルク表記 | GPIO | 割り当て機能 | 詳細 |
|----------|------|------------|------|
| **3V3** | - | 3.3V電源 | - |
| **RST** | - | リセット | - |
| **4** | 4 | - | 未使用（予備） |
| **5** | 5 | - | 未使用（予備） |
| **6** | 6 | - | 未使用（予備） |
| **7** | 7 | - | 未使用（予備） |
| **15** | 15 | - | 未使用（予備） |
| **16** | 16 | - | 未使用（予備） |
| **17** | 17 | **TMC_TX** 🔵 | TMC2209診断（Serial2） |
| **18** | 18 | **TMC_RX** 🔵 | TMC2209診断（Serial2） |
| **8** | 8 | **TUBE_TX** 🟢 | 筒側通信（Serial1） |
| **3** | 3 | - | 未使用（Strapping Pin） |
| **46** | 46 | - | 未使用（Strapping Pin） |
| **9** | 9 | **TUBE_RX** 🟢 | 筒側通信（Serial1） |
| **10** | 10 | **TMC2209_EN** 🟡 | ステッパーイネーブル |
| **11** | 11 | **TMC2209_MS1** 🟡 | マイクロステップ設定 |
| **12** | 12 | **TMC2209_MS2** 🟡 | マイクロステップ設定 |
| **13** | 13 | **TMC2209_STEP** 🟡 | ステップパルス |
| **14** | 14 | **TMC2209_DIR** 🟡 | 方向制御 |
| **5V** | - | 5V電源 | - |
| **GND** | - | グランド | - |

### 右側ヘッダー（上から下）

| シルク表記 | GPIO | 割り当て機能 | 詳細 |
|----------|------|------------|------|
| **GND** | - | グランド | - |
| **TX** | 43 | - | 未使用（UART0 TX、デバッグ用） |
| **RX** | 44 | - | 未使用（UART0 RX、デバッグ用） |
| **1** | 1 | - | 未使用（予備） |
| **2** | 2 | **SOLENOID** 🔴 | 電磁ブレーキ制御 |
| **42** | 42 | - | 未使用（JTAG） |
| **41** | 41 | - | 未使用（JTAG） |
| **40** | 40 | - | 未使用（JTAG） |
| **39** | 39 | - | 未使用（JTAG） |
| **38** | 38 | **LED_C** 🟠 | Winch照明ON/OFF |
| **37** | 37 | - | 未使用（予備） |
| **36** | 36 | - | 未使用（予備） |
| **35** | 35 | **LED_PWM** 🟠 | Winch照明輝度（PWM） |
| **0** | 0 | - | 未使用（Boot/Strapping） |
| **45** | 45 | - | 未使用（Strapping） |
| **48** | 48 | **NeoPixel** 🟣 | オンボードLED（システムステータス） |
| **47** | 47 | - | 未使用（予備） |
| **21** | 21 | - | 未使用（予備） |
| **20** | 20 | - | 未使用（USB D+） |
| **19** | 19 | - | 未使用（USB D-） |
| **NC** | - | 未接続 | - |
| **GND** | - | グランド | - |

---

## 📊 機能別ピンアサイン一覧

### 🟣 システムステータス（オンボード）

| GPIO | 機能 | ボード位置 |
|------|------|----------|
| **48** | NeoPixel RGB LED | 右側ヘッダー中央部 |

**詳細**: システムステータス表示用オンボードLED

---

### 🟢 UART1通信（筒側制御）

| GPIO | 信号 | ボード位置 |
|------|------|----------|
| **8** | TUBE_TX | 左側ヘッダー中央上部 |
| **9** | TUBE_RX | 左側ヘッダー中央下部 |

**仕様**:
- ボーレート: 38400 baud
- 伝送路: TO WPCBMS経由、24V + GND + TX + RX
- 接続先: U3マイコン（筒内部）
- コネクタ位置: 基板左側（Wireless module）

---

### 🟡 TMC2209ステッパー制御

| GPIO | 信号 | ボード位置 |
|------|------|----------|
| **10** | EN | 左側ヘッダー下部 |
| **11** | MS1 | 左側ヘッダー下部 |
| **12** | MS2 | 左側ヘッダー下部 |
| **13** | STEP | 左側ヘッダー下部 |
| **14** | DIR | 左側ヘッダー下部 |

**配置理由**: GPIO 10-14で連続5本、STEPPER_H2コネクタに近接

**マイクロステップ設定**:
| MS1 | MS2 | 分解能 |
|-----|-----|--------|
| LOW | LOW | 1/8 |
| HIGH | LOW | 1/16 |
| LOW | HIGH | 1/32 |
| HIGH | HIGH | 1/64 |

---

### 🔵 UART2通信（TMC2209診断）

| GPIO | 信号 | ボード位置 |
|------|------|----------|
| **17** | TMC_TX | 左側ヘッダー中央上部 |
| **18** | TMC_RX | 左側ヘッダー中央上部 |

**仕様**:
- ボーレート: 115200 baud
- 用途: TMC2209レジスタ読み書き、温度監視、ストール検出

---

### 🟠 LED Driver制御（Winch照明）

| GPIO | 信号 | ボード位置 |
|------|------|----------|
| **35** | LED_PWM | 右側ヘッダー中央 |
| **38** | LED_C | 右側ヘッダー中央上部 |

**仕様**:
- ドライバIC: TPS92200DDCR (U2)
- LED: 既製品3W LED
- 電源: 24V
- PWM周波数: 5kHz
- PWM分解能: 8bit (0-255)

**配置理由**: TPS92200DDCR（右側中央）に近接

---

### 🔴 電磁ブレーキ制御

| GPIO | 信号 | ボード位置 |
|------|------|----------|
| **2** | SOLENOID | 右側ヘッダー上部 |

**動作**:
| SOLENOID | Q2 | Q1 | ブレーキ |
|---------|-----|-----|---------|
| Hi-Z（起動時） | OFF | ON | **ON（安全）** |
| LOW | OFF | ON | **ON** |
| HIGH | ON | OFF | **OFF（解除）** |

**回路仕様**:
- Q2: NPN（R8=10kΩ、R6=100kΩプルダウン）
- Q1: 20N06 MOSFET
- フェイルセーフ: 起動時Hi-Z → プルダウン → ブレーキON

**配置理由**: ブレーキ回路Q2（左側下部）に近接

---

## 🎯 配線距離最適化の評価

### ✅ TMC2209グループ（GPIO 10-14, 17-18）

**左側ヘッダー配置**:
```
...
17 ──┐
18 ──┤ UART2（TMC2209診断）
8  ──┤
3    │
46   │
9  ──┤
10 ──┤
11 ──┤ TMC2209制御グループ（連続5本）
12 ──┤
13 ──┤
14 ──┘
...
```

- ✅ **連続配置**: GPIO 10-14で5本連続
- ✅ **物理的近接**: STEPPER_H2コネクタ（基板上部）に近い
- ✅ **配線距離**: 最短

---

### ✅ UART1グループ（GPIO 8-9）

**左側ヘッダー配置**:
```
...
17
18
8  ──┐ UART1（筒側通信）
3    │
46   │
9  ──┘
10
...
```

- ✅ **近接配置**: GPIO 8と9は2ピン離れているが、両方左側ヘッダー
- ✅ **物理的近接**: 電源通信コネクタ（基板左側）に近い
- ✅ **配線距離**: 短距離

---

### ✅ LED Driverグループ（GPIO 35, 38）

**右側ヘッダー配置**:
```
...
39
38 ──┐ LED Driver（Winch照明）
37   │
36   │
35 ──┘
0
...
```

- ✅ **近接配置**: GPIO 35と38は3ピン離れているが、両方右側ヘッダー中央
- ✅ **物理的近接**: TPS92200DDCR（右側中央）に近い
- ✅ **配線距離**: 短距離

---

### ✅ ブレーキ（GPIO 2）

**右側ヘッダー配置**:
```
GND
TX
RX
1
2  ── SOLENOID（ブレーキ）
42
...
```

- ✅ **物理的近接**: ブレーキ回路Q2（基板左下）へは横断が必要だが、右側上部から配線可能
- ⚠️ **配線距離**: やや長距離（基板を横断）

---

## 📝 使用GPIO統計

### 使用状況
- **使用中**: 13本
- **予備**: 22本
- **制約あり**: 11本（Strapping, USB, JTAG, UART0, 内部使用）

### 使用中GPIO詳細
```
GPIO 2:  SOLENOID (ブレーキ)
GPIO 8:  TUBE_TX (筒側通信)
GPIO 9:  TUBE_RX (筒側通信)
GPIO 10: TMC2209_EN
GPIO 11: TMC2209_MS1
GPIO 12: TMC2209_MS2
GPIO 13: TMC2209_STEP
GPIO 14: TMC2209_DIR
GPIO 17: TMC_TX (TMC2209診断)
GPIO 18: TMC_RX (TMC2209診断)
GPIO 35: LED_PWM (Winch照明)
GPIO 38: LED_C (Winch照明)
GPIO 48: NeoPixel (ステータス)
```

### 予備GPIO（拡張用）
```
GPIO 1, 4-7, 15-16, 21, 36-37, 47
```

---

## 🔧 ファームウェアGPIO定義

```cpp
// UART1（筒側通信）
#define TUBE_TX 8
#define TUBE_RX 9

// UART2（TMC2209通信）
#define TMC_TX 17
#define TMC_RX 18

// TMC2209制御
#define TMC2209_EN 10
#define TMC2209_MS1 11
#define TMC2209_MS2 12
#define TMC2209_STEP 13
#define TMC2209_DIR 14

// LED Driver（Winch照明用）
#define LED_C 38
#define LED_PWM 35

// 電磁ブレーキ
#define SOLENOID 2

// NeoPixel（システムステータス）
#define ONBOARD_LED_PIN 48
```

---

## 🔗 関連ドキュメント

| ドキュメント | 用途 |
|------------|------|
| [wpcbb-pinout-analysis.md](wpcbb-pinout-analysis.md) | PCBレイアウト解析とGPIO最適配置 |
| [winch-u1-esp32s3-pinout.md](winch-u1-esp32s3-pinout.md) | 詳細ピンアサイン仕様（V2アーキテクチャ） |
| [esp32s3-devkitc-pinout-reference.png](../../notes/esp32s3-devkitc-pinout-reference.png) | 参照ピンアウト図 |
| [esp32s3-devkitc-actual-board.png](../../notes/esp32s3-devkitc-actual-board.png) | 実際のボード写真（シルク確認） |

---

## ✅ 次のアクション

1. **PCB回路図確認**
   - EasyEDA/KiCadで実際の配線を確認
   - このピンアサインと一致するか検証

2. **ファームウェア更新**
   - `main.cpp`, `globals.h`のGPIO定義を更新
   - 上記のGPIO定義を使用

3. **基板発注**
   - 締切: 2025-10-24

---

**優先度**: 🔴 最優先（2025-10-24発注締切）
